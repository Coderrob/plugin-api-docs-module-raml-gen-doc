name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'yarn'
    
    - name: Install dependencies
      run: yarn install --frozen-lockfile
    
    - name: Run linter
      run: yarn lint
    
    - name: Run tests with coverage
      run: yarn test
    
    - name: Check coverage threshold (95%)
      run: |
        # Parse coverage from lcov.info file
        COVERAGE_FILE=coverage/lcov.info
        if [ -f "$COVERAGE_FILE" ]; then
          # Calculate coverage percentages using lcov data
          LINES_FOUND=$(grep -o "LF:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          LINES_HIT=$(grep -o "LH:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          BRANCHES_FOUND=$(grep -o "BRF:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          BRANCHES_HIT=$(grep -o "BRH:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          FUNCTIONS_FOUND=$(grep -o "FNF:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          FUNCTIONS_HIT=$(grep -o "FNH:[0-9]*" "$COVERAGE_FILE" | cut -d: -f2 | awk '{sum+=$1} END {print sum}')
          
          # Calculate percentages
          LINES_PCT=$(echo "scale=2; ($LINES_HIT / $LINES_FOUND) * 100" | bc)
          BRANCHES_PCT=$(echo "scale=2; ($BRANCHES_HIT / $BRANCHES_FOUND) * 100" | bc)
          FUNCTIONS_PCT=$(echo "scale=2; ($FUNCTIONS_HIT / $FUNCTIONS_FOUND) * 100" | bc)
          
          echo "Coverage Summary:"
          echo "  Lines: $LINES_PCT% ($LINES_HIT/$LINES_FOUND)"
          echo "  Branches: $BRANCHES_PCT% ($BRANCHES_HIT/$BRANCHES_FOUND)"
          echo "  Functions: $FUNCTIONS_PCT% ($FUNCTIONS_HIT/$FUNCTIONS_FOUND)"
          
          # Check if all metrics meet the 95% threshold
          THRESHOLD=95
          LINES_OK=$(echo "$LINES_PCT >= $THRESHOLD" | bc)
          BRANCHES_OK=$(echo "$BRANCHES_PCT >= $THRESHOLD" | bc)
          FUNCTIONS_OK=$(echo "$FUNCTIONS_PCT >= $THRESHOLD" | bc)
          
          if [ "$LINES_OK" -eq 1 ] && [ "$BRANCHES_OK" -eq 1 ] && [ "$FUNCTIONS_OK" -eq 1 ]; then
            echo "✅ Coverage meets 95% threshold!"
            exit 0
          else
            echo "❌ Coverage is below 95% threshold!"
            [ "$LINES_OK" -eq 0 ] && echo "  - Lines coverage ($LINES_PCT%) is below $THRESHOLD%"
            [ "$BRANCHES_OK" -eq 0 ] && echo "  - Branches coverage ($BRANCHES_PCT%) is below $THRESHOLD%"
            [ "$FUNCTIONS_OK" -eq 0 ] && echo "  - Functions coverage ($FUNCTIONS_PCT%) is below $THRESHOLD%"
            exit 1
          fi
        else
          echo "❌ Coverage file not found!"
          exit 1
        fi
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: matrix.node-version == '20.x'
      with:
        name: coverage-report
        path: coverage/
